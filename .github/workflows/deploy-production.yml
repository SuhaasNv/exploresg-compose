name: ğŸš€ Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Docker image tag to deploy (default: latest)'
        required: false
        default: 'latest'
      services:
        description: 'Services to deploy (comma-separated, leave empty for all)'
        required: false
        default: ''

env:
  DROPLET_IP: ${{ secrets.DO_DROPLET_IP }}
  DROPLET_USER: root
  DEPLOY_PATH: /opt/exploresg/docker-compose

jobs:
  deploy:
    name: ğŸš€ Deploy ExploreSG to Production
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Deployment Environment
      run: |
        echo "ğŸš€ Starting ExploreSG Production Deployment"
        echo "ğŸ“ Target: ${{ env.DROPLET_IP }}"
        echo "ğŸ·ï¸ Tag: ${{ github.event.inputs.tag || 'latest' }}"
        echo "ğŸ“¦ Services: ${{ github.event.inputs.services || 'all' }}"
        
    - name: ğŸ” Setup SSH Key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.DO_SSH_PRIVATE_KEY }}
        
    - name: ğŸ“‹ Pre-deployment Health Check
      run: |
        echo "ğŸ¥ Checking current deployment status..."
        ssh -o StrictHostKeyChecking=no ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }} \
          "cd ${{ env.DEPLOY_PATH }} && docker compose ps" || echo "âš ï¸ No existing deployment found"
          
    - name: ğŸ“¦ Copy Files to Droplet
      run: |
        echo "ğŸ“¦ Copying deployment files..."
        scp -o StrictHostKeyChecking=no compose.yaml ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }}:${{ env.DEPLOY_PATH }}/
        scp -o StrictHostKeyChecking=no nginx-gateway.conf ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }}:${{ env.DEPLOY_PATH }}/
        scp -o StrictHostKeyChecking=no health-check.sh ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }}:${{ env.DEPLOY_PATH }}/
        
        # Ensure db directory exists and copy database files
        echo "ğŸ“¦ Setting up database files..."
        ssh -o StrictHostKeyChecking=no ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }} "mkdir -p ${{ env.DEPLOY_PATH }}/db"
        
        # Copy database files with error handling
        echo "Copying schema file..."
        if scp -o StrictHostKeyChecking=no db/00-schema.sql ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }}:${{ env.DEPLOY_PATH }}/db/; then
          echo "âœ… Schema file copied successfully"
        else
          echo "âš ï¸ Schema file copy failed, but continuing..."
        fi
        
        echo "Copying seed file..."
        if scp -o StrictHostKeyChecking=no db/seed-fleet.sql ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }}:${{ env.DEPLOY_PATH }}/db/; then
          echo "âœ… Seed file copied successfully"
        else
          echo "âš ï¸ Seed file copy failed, but continuing..."
        fi
        
        # Make scripts executable
        ssh -o StrictHostKeyChecking=no ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }} \
          "chmod +x ${{ env.DEPLOY_PATH }}/health-check.sh"
        
    - name: ğŸ³ Pull Latest Images
      run: |
        echo "ğŸ“¥ Pulling latest Docker images..."
        ssh -o StrictHostKeyChecking=no ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }} \
          "cd ${{ env.DEPLOY_PATH }} && docker compose pull"
          
    - name: ğŸ›‘ Graceful Service Shutdown
      run: |
        echo "ğŸ›‘ Gracefully stopping services..."
        ssh -o StrictHostKeyChecking=no ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }} \
          "cd ${{ env.DEPLOY_PATH }} && docker compose down --timeout 30" || echo "âš ï¸ Some services may not have been running"
          
    - name: ğŸš€ Deploy Services
      run: |
        echo "ğŸš€ Starting services with latest images..."
        ssh -o StrictHostKeyChecking=no ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }} \
          "cd ${{ env.DEPLOY_PATH }} && docker compose up -d"
          
    - name: â³ Wait for Services to Start
      run: |
        echo "â³ Waiting for services to initialize..."
        sleep 60
        
    - name: ğŸ¥ Health Check
      run: |
        echo "ğŸ¥ Running health checks..."
        ssh -o StrictHostKeyChecking=no ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }} \
          "cd ${{ env.DEPLOY_PATH }} && DROPLET_IP=${{ env.DROPLET_IP }} ./health-check.sh" || echo "âš ï¸ Health check script not found, running manual checks"
          
        # Manual health checks as backup
        echo "ğŸ” Running backup health checks..."
        for service in auth fleet booking payment; do
          port=""
          case "$service" in
            auth) port=8081 ;;
            fleet) port=8082 ;;
            booking) port=8083 ;;
            payment) port=8084 ;;
          esac
          echo "Checking $service on port $port..."
          curl -f http://${{ env.DROPLET_IP }}:$port/actuator/health || echo "âš ï¸ $service not responding"
        done
        
    - name: ğŸ“Š Deployment Status
      run: |
        echo "ğŸ“Š Final deployment status:"
        ssh -o StrictHostKeyChecking=no ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }} \
          "cd ${{ env.DEPLOY_PATH }} && docker compose ps"
          
    - name: ğŸ‰ Deployment Success
      if: success()
      run: |
        echo "ğŸ‰ ExploreSG Production Deployment Successful!"
        echo "ğŸŒ Frontend: http://${{ env.DROPLET_IP }}:3000"
        echo "ğŸ”— Fleet API: http://${{ env.DROPLET_IP }}:8082/api/v1/fleet/models"
        echo "ğŸ”— Auth API: http://${{ env.DROPLET_IP }}:8081/actuator/health"
        
    - name: ğŸš¨ Deployment Failed
      if: failure()
      run: |
        echo "ğŸš¨ Deployment failed! Check logs above."
        echo "ğŸ”„ Consider rolling back to previous version..."
        exit 1
