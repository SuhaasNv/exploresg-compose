name: üîß Deploy Individual Service

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy'
        required: true
        type: choice
        options:
          - frontend
          - auth
          - fleet
          - booking
          - payment
          - all
      tag:
        description: 'Docker image tag to deploy'
        required: false
        default: 'latest'
      force_restart:
        description: 'Force restart even if no changes'
        required: false
        type: boolean
        default: false

env:
  DROPLET_IP: ${{ secrets.DO_DROPLET_IP }}
  DROPLET_USER: root
  DEPLOY_PATH: /opt/exploresg/docker-compose

jobs:
  deploy-service:
    name: üîß Deploy ${{ github.event.inputs.service }} Service
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      
    - name: üîß Setup Service Deployment
      run: |
        echo "üîß Starting ${{ github.event.inputs.service }} Service Deployment"
        echo "üìç Target: ${{ env.DROPLET_IP }}"
        echo "üè∑Ô∏è Tag: ${{ github.event.inputs.tag }}"
        echo "üîÑ Force Restart: ${{ github.event.inputs.force_restart }}"
        
    - name: üîê Setup SSH Key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.DO_SSH_PRIVATE_KEY }}
        
    - name: üìã Check Current Service Status
      run: |
        echo "üìã Checking current service status..."
        ssh -o StrictHostKeyChecking=no ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }} \
          "cd ${{ env.DEPLOY_PATH }} && docker compose ps ${{ github.event.inputs.service }}" || echo "‚ö†Ô∏è Service not currently running"
          
    - name: üì¶ Copy Updated Files
      if: github.event.inputs.service == 'all' || github.event.inputs.service == 'frontend'
      run: |
        echo "üì¶ Copying updated configuration files..."
        scp -o StrictHostKeyChecking=no compose.yaml ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }}:${{ env.DEPLOY_PATH }}/
        scp -o StrictHostKeyChecking=no nginx-gateway.conf ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }}:${{ env.DEPLOY_PATH }}/
        scp -o StrictHostKeyChecking=no health-check.sh ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }}:${{ env.DEPLOY_PATH }}/
        
        # Copy database files if they don't exist
        echo "üì¶ Ensuring database files exist..."
        ssh -o StrictHostKeyChecking=no ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }} "mkdir -p ${{ env.DEPLOY_PATH }}/db"
        scp -o StrictHostKeyChecking=no db/00-schema.sql ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }}:${{ env.DEPLOY_PATH }}/db/ || echo "‚ö†Ô∏è Schema file copy failed"
        scp -o StrictHostKeyChecking=no db/seed-fleet.sql ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }}:${{ env.DEPLOY_PATH }}/db/ || echo "‚ö†Ô∏è Seed file copy failed"
        
        # Make scripts executable
        ssh -o StrictHostKeyChecking=no ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }} \
          "chmod +x ${{ env.DEPLOY_PATH }}/health-check.sh"
        
    - name: üê≥ Pull Latest Image
      run: |
        echo "üì• Pulling latest image for ${{ github.event.inputs.service }}..."
        if [ "${{ github.event.inputs.service }}" = "all" ]; then
          ssh -o StrictHostKeyChecking=no ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }} \
            "cd ${{ env.DEPLOY_PATH }} && docker compose pull"
        else
          ssh -o StrictHostKeyChecking=no ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }} \
            "cd ${{ env.DEPLOY_PATH }} && docker compose pull ${{ github.event.inputs.service }}"
        fi
        
    - name: üõë Stop Service
      run: |
        echo "üõë Stopping ${{ github.event.inputs.service }} service..."
        if [ "${{ github.event.inputs.service }}" = "all" ]; then
          ssh -o StrictHostKeyChecking=no ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }} \
            "cd ${{ env.DEPLOY_PATH }} && docker compose stop"
        else
          ssh -o StrictHostKeyChecking=no ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }} \
            "cd ${{ env.DEPLOY_PATH }} && docker compose stop ${{ github.event.inputs.service }}"
        fi
        
    - name: üóëÔ∏è Remove Old Container
      run: |
        echo "üóëÔ∏è Removing old container..."
        if [ "${{ github.event.inputs.service }}" = "all" ]; then
          ssh -o StrictHostKeyChecking=no ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }} \
            "cd ${{ env.DEPLOY_PATH }} && docker compose rm -f"
        else
          ssh -o StrictHostKeyChecking=no ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }} \
            "cd ${{ env.DEPLOY_PATH }} && docker compose rm -f ${{ github.event.inputs.service }}"
        fi
        
    - name: üöÄ Start Service
      run: |
        echo "üöÄ Starting ${{ github.event.inputs.service }} service..."
        if [ "${{ github.event.inputs.service }}" = "all" ]; then
          ssh -o StrictHostKeyChecking=no ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }} \
            "cd ${{ env.DEPLOY_PATH }} && docker compose up -d"
        else
          ssh -o StrictHostKeyChecking=no ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }} \
            "cd ${{ env.DEPLOY_PATH }} && docker compose up -d ${{ github.event.inputs.service }}"
        fi
        
    - name: ‚è≥ Wait for Service Startup
      run: |
        echo "‚è≥ Waiting for ${{ github.event.inputs.service }} to start..."
        sleep 30
        
    - name: üè• Service Health Check
      run: |
        echo "üè• Checking ${{ github.event.inputs.service }} health..."
        
        case "${{ github.event.inputs.service }}" in
          "frontend")
            echo "Checking frontend..."
            curl -f http://${{ env.DROPLET_IP }}:3000 || echo "‚ö†Ô∏è Frontend not responding"
            ;;
          "auth")
            echo "Checking auth service..."
            curl -f http://${{ env.DROPLET_IP }}:8081/actuator/health || echo "‚ö†Ô∏è Auth service not responding"
            ;;
          "fleet")
            echo "Checking fleet service..."
            curl -f http://${{ env.DROPLET_IP }}:8082/actuator/health || echo "‚ö†Ô∏è Fleet service not responding"
            ;;
          "booking")
            echo "Checking booking service..."
            curl -f http://${{ env.DROPLET_IP }}:8083/actuator/health || echo "‚ö†Ô∏è Booking service not responding"
            ;;
          "payment")
            echo "Checking payment service..."
            curl -f http://${{ env.DROPLET_IP }}:8084/actuator/health || echo "‚ö†Ô∏è Payment service not responding"
            ;;
          "all")
            echo "Checking all services..."
            for service in frontend auth fleet booking payment; do
              case "$service" in
                "frontend") port=3000; path="" ;;
                "auth") port=8081; path="/actuator/health" ;;
                "fleet") port=8082; path="/actuator/health" ;;
                "booking") port=8083; path="/actuator/health" ;;
                "payment") port=8084; path="/actuator/health" ;;
              esac
              echo "Checking $service on port $port..."
              curl -f http://${{ env.DROPLET_IP }}:$port$path || echo "‚ö†Ô∏è $service not responding"
            done
            ;;
        esac
        
    - name: üìä Service Status
      run: |
        echo "üìä Final service status:"
        ssh -o StrictHostKeyChecking=no ${{ env.DROPLET_USER }}@${{ env.DROPLET_IP }} \
          "cd ${{ env.DEPLOY_PATH }} && docker compose ps ${{ github.event.inputs.service }}"
          
    - name: üéâ Service Deployment Success
      if: success()
      run: |
        echo "üéâ ${{ github.event.inputs.service }} Service Deployment Successful!"
        case "${{ github.event.inputs.service }}" in
          "frontend")
            echo "üåê Frontend: http://${{ env.DROPLET_IP }}:3000"
            ;;
          "auth")
            echo "üîó Auth API: http://${{ env.DROPLET_IP }}:8081/actuator/health"
            ;;
          "fleet")
            echo "üîó Fleet API: http://${{ env.DROPLET_IP }}:8082/api/v1/fleet/models"
            ;;
          "booking")
            echo "üîó Booking API: http://${{ env.DROPLET_IP }}:8083/actuator/health"
            ;;
          "payment")
            echo "üîó Payment API: http://${{ env.DROPLET_IP }}:8084/actuator/health"
            ;;
          "all")
            echo "üåê Frontend: http://${{ env.DROPLET_IP }}:3000"
            echo "üîó Fleet API: http://${{ env.DROPLET_IP }}:8082/api/v1/fleet/models"
            echo "üîó Auth API: http://${{ env.DROPLET_IP }}:8081/actuator/health"
            ;;
        esac
