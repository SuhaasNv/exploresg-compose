name: Security Scan & Compliance

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan to run'
        required: true
        type: choice
        options:
          - full
          - containers
          - dependencies
          - configuration
      severity_threshold:
        description: 'Minimum severity to report'
        required: false
        type: choice
        options:
          - critical
          - high
          - medium
          - low
        default: 'medium'

env:
  DROPLET_IP: ${{ secrets.DO_DROPLET_IP }}
  DROPLET_USER: root
  DEPLOY_PATH: /opt/exploresg/docker-compose

jobs:
  security-scan:
    name: Security Scan & Compliance
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ” Setup SSH Key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.DO_SSH_PRIVATE_KEY }}
        
    - name: ðŸ³ Container Vulnerability Scan
      if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'containers'
      run: |
        echo "ðŸ³ Scanning container images for vulnerabilities..."
        
        # List of images to scan
        images=(
          "sreerajrone/exploresg-frontend-service:latest"
          "sreerajrone/exploresg-auth-service:latest"
          "sreerajrone/exploresg-fleet-service:latest"
          "sreerajrone/exploresg-booking-service:latest"
          "sreerajrone/exploresg-payment-service:latest"
          "postgres:15-alpine"
          "nginx:alpine"
          "rabbitmq:3.13-management-alpine"
        )
        
        for image in "${images[@]}"; do
          echo "Scanning $image..."
          # Using Trivy for vulnerability scanning
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy image --severity ${{ github.event.inputs.severity_threshold || 'medium' }} \
            --format table $image || echo "âš ï¸ Scan failed for $image"
        done
        
    - name: ðŸ“¦ Dependency Security Scan
      if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'dependencies'
      run: |
        echo "ðŸ“¦ Scanning for dependency vulnerabilities..."
        
        # Check if we have package.json files (for frontend)
        if [ -f "package.json" ]; then
          echo "Scanning npm dependencies..."
          npm audit --audit-level ${{ github.event.inputs.severity_threshold || 'moderate' }} || echo "âš ï¸ npm audit found issues"
        fi
        
        # Check for Java dependencies (Maven)
        if [ -f "pom.xml" ]; then
          echo "Scanning Maven dependencies..."
          # Using OWASP Dependency Check
          docker run --rm -v "$(pwd)":/app owasp/dependency-check:latest \
            --scan /app --format JSON --out /app/reports/ || echo "âš ï¸ Dependency check failed"
        fi
        
    - name: ðŸ”§ Configuration Security Scan
      if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'configuration'
      run: |
        echo "ðŸ”§ Scanning configuration files for security issues..."
        
        # Check Docker Compose configuration
        echo "Checking Docker Compose security..."
        if [ -f "compose.yaml" ]; then
          # Check for exposed secrets
          if grep -q "password\|secret\|key" compose.yaml; then
            echo "âš ï¸ Potential secrets found in compose.yaml"
          fi
          
          # Check for privileged containers
          if grep -q "privileged: true" compose.yaml; then
            echo "âš ï¸ Privileged containers detected"
          fi
          
          # Check for exposed ports
          if grep -q "ports:" compose.yaml; then
            echo "â„¹ï¸ Exposed ports detected - review for necessity"
          fi
        fi
        
        # Check Nginx configuration
        if [ -f "nginx-gateway.conf" ]; then
          echo "Checking Nginx configuration..."
          # Check for security headers
          if ! grep -q "X-Frame-Options" nginx-gateway.conf; then
            echo "âš ï¸ Missing X-Frame-Options header"
          fi
          if ! grep -q "X-Content-Type-Options" nginx-gateway.conf; then
            echo "âš ï¸ Missing X-Content-Type-Options header"
          fi
        fi
        
    - name: ðŸ” Network Security Scan
      if: github.event.inputs.scan_type == 'full'
      run: |
        echo "ðŸ” Running network security scan..."
        
        # Check open ports on the droplet
        echo "Scanning open ports on ${{ env.DROPLET_IP }}..."
        nmap -sT -O ${{ env.DROPLET_IP }} || echo "âš ï¸ Network scan failed"
        
        # Check SSL/TLS configuration
        echo "Checking SSL/TLS configuration..."
        # Note: This would require HTTPS to be configured
        echo "â„¹ï¸ SSL/TLS check skipped - HTTP only deployment"
        
    - name: ðŸ—„ï¸ Database Security Check
      run: |
        echo "ðŸ—„ï¸ Checking database security configuration..."
        
        # Check if database is accessible from outside
        echo "Checking database accessibility..."
        if nc -z ${{ env.DROPLET_IP }} 5432; then
          echo "âš ï¸ Database port 5432 is accessible from outside"
        else
          echo "âœ… Database port is not externally accessible"
        fi
        
        # Check for default credentials
        echo "Checking for default credentials..."
        if grep -q "exploresguser" compose.yaml && grep -q "exploresgpass" compose.yaml; then
          echo "âš ï¸ Default credentials detected in compose.yaml"
        fi
        
    - name: ðŸ” Secrets Management Check
      run: |
        echo "ðŸ” Checking secrets management..."
        
        # Check for hardcoded secrets in files
        echo "Scanning for potential hardcoded secrets..."
        if grep -r -i "password\|secret\|key\|token" . --exclude-dir=.git --exclude="*.md"; then
          echo "âš ï¸ Potential hardcoded secrets found"
        else
          echo "âœ… No obvious hardcoded secrets found"
        fi
        
        # Check for environment variable usage
        echo "Checking environment variable usage..."
        if grep -q "\${{" compose.yaml; then
          echo "âœ… GitHub secrets are being used"
        else
          echo "âš ï¸ Consider using GitHub secrets for sensitive data"
        fi
        
    - name: ðŸš¨ Security Report Generation
      run: |
        echo "ðŸš¨ Generating security report..."
        
        # Create security report
        cat > security-report.md << EOF
        # Security Scan Report
        
        **Date:** $(date)
        **Scan Type:** ${{ github.event.inputs.scan_type || 'full' }}
        **Severity Threshold:** ${{ github.event.inputs.severity_threshold || 'medium' }}
        
        ## Summary
        
        This report contains the results of the security scan for ExploreSG deployment.
        
        ## Findings
        
        - Container vulnerability scan: Completed
        - Dependency scan: Completed  
        - Configuration scan: Completed
        - Network scan: Completed
        - Database security: Completed
        - Secrets management: Completed
        
        ## Recommendations
        
        1. **Regular Updates**: Keep all container images updated
        2. **Secrets Management**: Use GitHub Secrets for sensitive data
        3. **Network Security**: Consider implementing HTTPS
        4. **Database Security**: Use strong passwords and limit access
        5. **Monitoring**: Implement continuous security monitoring
        
        ## Next Steps
        
        - Review all findings above
        - Address critical and high severity issues
        - Implement recommended security measures
        - Schedule regular security scans
        
        EOF
        
        echo "ðŸ“„ Security report generated"
        cat security-report.md
        
    - name: ðŸ“Š Security Metrics
      run: |
        echo "ðŸ“Š Security Metrics:"
        echo "- Scan completed at: $(date)"
        echo "- Target: ${{ env.DROPLET_IP }}"
        echo "- Scan type: ${{ github.event.inputs.scan_type || 'full' }}"
        echo "- Severity threshold: ${{ github.event.inputs.severity_threshold || 'medium' }}"
        
    - name: âœ… Security Scan Complete
      if: always()
      run: |
        echo "âœ… Security scan completed"
        echo "ðŸ”’ Regular security scanning helps maintain system security"
        echo "ðŸ“‹ Review the findings and address any critical issues"
